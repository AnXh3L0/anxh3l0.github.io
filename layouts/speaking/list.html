{{ define "main" }}
{{ if .IsPage }}
  {{ partial "speaking.html" . }}
{{ end }}
<main class="flex-auto" role="main" {{ if .IsTranslated }}lang="{{ .Language.Lang }}"{{ end }}>
    <div class="mt-16 sm:px-8 lg:mt-32">
      <section class="mx-auto w-full max-w-7xl lg:px-8">
        <div class="relative px-4 sm:px-8 lg:px-12">
          <div class="mx-auto max-w-2xl lg:max-w-5xl">
            <header class="max-w-2xl">
              <h1 class="text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl">
                {{ i18n "speaking_title" }}
              </h1>
              <p class="mt-6 text-base text-zinc-600 dark:text-zinc-400">
                {{ i18n "speaking_description" }}
              </p>
            </header>

            <p>{{ .Content }}</p>
      
            <div class="mt-16 sm:mt-20">
              <div class="space-y-20">
                {{ range sort .Site.Data.speaking.entries "date" "desc" }}

                  <article class="group relative flex flex-col items-start" 
                           lang="{{ .lang }}" 
                           data-platform="{{ .platform }}" 
                           data-video-id="{{ .video_id | relURL }}" 
                           data-domain="{{ .domain }}" 
                           data-ext="{{ .ext }}"
                           aria-labelledby="appearance-{{ anchorize .title }}">
                    
                    <h2 class="text-base font-semibold tracking-tight text-zinc-800 dark:text-zinc-100" 
                        id="appearance-{{ anchorize .title }}">
                      <div class="absolute -inset-x-4 -inset-y-6 z-0 scale-95 bg-zinc-50 opacity-0 transition group-hover:scale-100 group-hover:opacity-100 dark:bg-zinc-800/50 sm:-inset-x-6 sm:rounded-2xl"></div>
                      <span class="relative z-10">{{ .title }}</span>
                    </h2>
      
                    <div class="relative z-10 order-first mb-3 flex items-center pl-3.5 text-sm text-zinc-400 dark:text-zinc-500">
                      <span class="absolute inset-y-0 left-0 flex items-center" aria-hidden="true">
                        <span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
                      </span>
                      {{ .event }} ({{ dateFormat "2 January 2006" .date }})
                    </div>
      
                    <div class="video-container mt-4 w-full" data-loaded="false">
                      {{ if eq .platform "youtube" }}
                        {{ partial "players/youtube" . }}
                      {{ else if eq .platform "facebook" }}
                        {{ partial "players/facebook" . }}
                      {{ else if eq .platform "bbb" }}
                        {{ partial "players/bbb" . }}
                      {{ else if eq .platform "audio" }}
                        {{ partial "players/audio" . }}
                      {{ else }}
                        {{ partial "players/generic" . }}
                      {{ end }}
                    </div>
      
                    <div class="relative z-10 mt-4 text-sm text-zinc-600 dark:text-zinc-400">
                      {{ .description | markdownify }}
                    </div>
                  </article>
                {{ end }}
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Format time helper
  function formatTime(seconds) {
    if (isNaN(seconds) || !isFinite(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  // Initialize custom audio player controls
  function initAudioPlayer(playerContainer) {
    const audio = playerContainer.querySelector('.audio-element');
    const playPauseBtn = playerContainer.querySelector('.play-pause-btn');
    const playIcon = playerContainer.querySelector('.play-icon');
    const pauseIcon = playerContainer.querySelector('.pause-icon');
    const progressContainer = playerContainer.querySelector('.progress-container');
    const progressBar = playerContainer.querySelector('.progress-bar');
    const progressHandle = playerContainer.querySelector('.progress-handle');
    const currentTimeEl = playerContainer.querySelector('.current-time');
    const durationEl = playerContainer.querySelector('.duration');
    const volumeBtn = playerContainer.querySelector('.volume-btn');
    const volumeHighIcon = playerContainer.querySelector('.volume-high-icon');
    const volumeLowIcon = playerContainer.querySelector('.volume-low-icon');
    const mutedIcon = playerContainer.querySelector('.muted-icon');
    const volumeSlider = playerContainer.querySelector('.volume-slider');
    const speedBtn = playerContainer.querySelector('.speed-btn');

    if (!audio) return;

    let isDragging = false;
    const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
    let speedIndex = 2; // Start at 1x

    // Update progress bar
    function updateProgress() {
      if (!audio.duration) return;
      const percent = (audio.currentTime / audio.duration) * 100;
      progressBar.style.width = percent + '%';
      progressHandle.style.left = percent + '%';
      currentTimeEl.textContent = formatTime(audio.currentTime);
    }

    // Update volume icons
    function updateVolumeIcon() {
      const vol = audio.muted ? 0 : audio.volume;
      volumeHighIcon.classList.toggle('hidden', vol <= 0.5);
      volumeLowIcon.classList.toggle('hidden', vol === 0 || vol > 0.5);
      mutedIcon.classList.toggle('hidden', vol > 0);
    }

    // Play/Pause
    playPauseBtn.addEventListener('click', () => {
      audio.paused ? audio.play() : audio.pause();
    });

    audio.addEventListener('play', () => {
      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
    });

    audio.addEventListener('pause', () => {
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
    });

    // Progress updates
    audio.addEventListener('timeupdate', updateProgress);

    // Duration
    function setDuration() {
      if (audio.duration && isFinite(audio.duration)) {
        durationEl.textContent = formatTime(audio.duration);
      }
    }
    audio.addEventListener('loadedmetadata', setDuration);
    audio.addEventListener('durationchange', setDuration);
    audio.addEventListener('canplay', setDuration);

    // Show handle on hover/touch
    progressContainer.addEventListener('mouseenter', () => {
      progressHandle.style.opacity = '1';
    });
    progressContainer.addEventListener('mouseleave', () => {
      if (!isDragging) progressHandle.style.opacity = '0';
    });

    // Seek function - works with both mouse and touch
    function seek(clientX) {
      const rect = progressContainer.getBoundingClientRect();
      const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
      if (audio.duration && isFinite(audio.duration)) {
        audio.currentTime = percent * audio.duration;
        updateProgress();
      }
    }

    // Mouse events
    progressContainer.addEventListener('mousedown', (e) => {
      isDragging = true;
      progressHandle.style.opacity = '1';
      seek(e.clientX);
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) seek(e.clientX);
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        progressHandle.style.opacity = '0';
      }
    });

    // Touch events for mobile
    progressContainer.addEventListener('touchstart', (e) => {
      isDragging = true;
      progressHandle.style.opacity = '1';
      const touch = e.touches[0];
      seek(touch.clientX);
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchmove', (e) => {
      if (isDragging && e.touches.length > 0) {
        seek(e.touches[0].clientX);
      }
    }, { passive: true });

    document.addEventListener('touchend', () => {
      if (isDragging) {
        isDragging = false;
        progressHandle.style.opacity = '0';
      }
    });

    // Volume mute toggle
    volumeBtn.addEventListener('click', () => {
      audio.muted = !audio.muted;
      volumeSlider.value = audio.muted ? 0 : audio.volume;
      updateVolumeIcon();
    });

    // Volume slider
    volumeSlider.addEventListener('input', (e) => {
      audio.volume = parseFloat(e.target.value);
      audio.muted = audio.volume === 0;
      updateVolumeIcon();
    });

    // Speed control
    speedBtn.addEventListener('click', () => {
      speedIndex = (speedIndex + 1) % speeds.length;
      audio.playbackRate = speeds[speedIndex];
      speedBtn.textContent = speeds[speedIndex] + 'x';
    });

    // Initialize volume
    volumeSlider.value = audio.volume;
    updateVolumeIcon();
  }

  // Initialize all video/audio thumbnails
  document.querySelectorAll('.thumbnail-button').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const container = this.parentElement;
      if (container.dataset.loaded === 'true') return;

      const article = this.closest('article');
      const platform = article.dataset.platform;
      const domain = article.dataset.domain;
      const ext = article.dataset.ext;
      const videoId = article.dataset.videoId;
      const timestamp = this.dataset.timestamp || 0;

      // Handle audio - reveal custom player
      if (platform === 'audio') {
        const audioPlayer = container.querySelector('.custom-audio-player');
        const thumbnailBtn = container.querySelector('.thumbnail-button');
        if (audioPlayer && thumbnailBtn) {
          thumbnailBtn.classList.add('hidden');
          audioPlayer.classList.remove('hidden');
          initAudioPlayer(audioPlayer);
          const audioEl = audioPlayer.querySelector('.audio-element');
          if (audioEl) {
            if (timestamp) audioEl.currentTime = parseInt(timestamp);
            audioEl.play();
          }
          container.dataset.loaded = 'true';
        }
        return;
      }

      // Create loader element for video platforms
      const loader = document.createElement('div');
      loader.className = 'loader animate-spin w-8 h-8 border-4 border-teal-500 rounded-full';
      container.innerHTML = '';
      container.appendChild(loader);

      // Create iframe after short delay to show loading state
      setTimeout(() => {
        const iframe = createPlayer(platform, videoId, timestamp, domain, ext);
        container.innerHTML = '';
        container.appendChild(iframe);
        container.dataset.loaded = 'true';
      }, 300);
    });
  });

  function createPlayer(platform, videoId, timestamp, domain, ext) {
    const iframe = document.createElement('iframe');
    iframe.className = 'w-full aspect-video rounded-lg bg-zinc-900';
    iframe.allowFullscreen = true;
    iframe.loading = 'lazy';
    
    switch(platform) {
      case 'youtube':
        iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&start=${timestamp}&rel=0&modestbranding=1`;
        iframe.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture';
        break;
      case 'facebook':
        const videoUrl = `https://www.facebook.com/watch/?v=${videoId}`;
        iframe.src = `https://www.facebook.com/plugins/video.php?height=314&href=${encodeURIComponent(videoUrl)}&show_text=false&width=560&t=${timestamp}`;
        iframe.allow = 'autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share';
        break;
      case 'bbb':
        let totalSeconds = timestamp;
        if (typeof timestamp === 'string' && timestamp.includes('m')) {
          const [minutes, seconds] = timestamp.replace('s', '').split('m');
          totalSeconds = (parseInt(minutes) * 60) + (parseInt(seconds) || 0);
        }
        iframe.src = `https://${domain}/playback/presentation/2.0/playback.html?meetingId=${videoId}&t=${totalSeconds}`;
        iframe.allow = 'autoplay; fullscreen';
        break;
      default:
        console.error('Unsupported platform:', platform);
      }
    return iframe;
  }
});
</script>
{{ end }}